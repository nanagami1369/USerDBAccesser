<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/main.css" />
    <title>UserDBAccesser</title>
  </head>
  <body>
    <header id="main-header" class="content">
      <h1>UserDBAccesser</h1>
    </header>
    <main>
      <form id="add-user-form">
        <h4>アカウントの追加</h4>
        <label>名前</label>
        <input type="text" name="name" id="add-user-input-name" required />
        <label>パスワード(8文字以上)</label>
        <input
          type="password"
          name="password"
          pattern=".{8,}"
          id="add-user-input-password"
          required
        />
        <label>状態</label>
        <label for="avail-ragio-true">
          <input
            type="radio"
            name="avail"
            value="true"
            id="avail-ragio-true"
            checked
          />有効
        </label>
        <label for="avail-ragio-false">
          <input
            type="radio"
            name="avail"
            value="false"
            id="avail-ragio-false"
          />無効
        </label>
        <label>権限</label>
        <label for="level-radio-admin">
          <input
            type="radio"
            name="level"
            value="ADMIN"
            id="level-radio-admin"
            checked
          />管理者
        </label>
        <label for="level-radio-prem">
          <input
            type="radio"
            name="level"
            value="PREM"
            id="level-radio-prem"
          />プレミア
        </label>
        <label for="level-radio-gen">
          <input
            type="radio"
            name="level"
            value="GEN"
            id="level-radio-gen"
          />一般
        </label>
        <label for="level-radio-try">
          <input
            type="radio"
            name="level"
            value="TRY"
            id="level-radio-try"
          />お試し
        </label>
        <input
          id="send-form-add-user-button"
          type="button"
          value="アカウントを追加する"
        />
      </form>
      <table id="user-data-table"></table>
    </main>
  </body>
  <script type="module">
    import { escapeHtml } from './js/main.js'

    const availToString = (avail) => {
      if (avail == 1) {
        return '有効'
      } else {
        return '無効'
      }
    }
    const reloadTable = async () => {
      const cgiUrl = './cgi-bin/UserDBAccesser.cgi'
      const method = 'post'

      const response = await fetch(cgiUrl, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ method: 'getAll' }),
      })
      const userData = await response.json()
      const userTableElement = document.querySelector('#user-data-table')
      // テーブルの削除
      while (userTableElement.firstChild)
        userTableElement.removeChild(userTableElement.firstChild)
      // ヘッダー生成
      const userTableHeader =
        '<tr><th>ID</th><th>名前</th><th>パスワード</th><th>状態</th><th>権限</th></tr>'
      let tableHtml = userTableHeader
      userTableElement.innerHTML = tableHtml
      // 要素の生成
      userData.users.forEach((user) => {
        userTableElement.innerHTML +=
          '<tr><td>' +
          user.id +
          '</td><td>' +
          escapeHtml(user.name) +
          '</td><td>********</td><td>' +
          availToString(user.avail) +
          '</td><td>' +
          user.level +
          '</td></tr>'
      })
      return
    }
    reloadTable()
    const sendFormAddUser = async () => {
      const cgiUrl = './cgi-bin/UserDBAccesser.cgi'
      const method = 'post'
      const addUserFormElement = document.querySelector('#add-user-form')
      // ユーザー名
      const name = addUserFormElement.name.value
      // パスワード
      const password = addUserFormElement.password.value
      // 状態
      const avail = addUserFormElement.avail.value
      // 権限
      const level = addUserFormElement.level.value
      const sendAddUserJson = JSON.stringify({
        method: 'add',
        name: name,
        pass: password,
        avail: avail,
        level: level,
      })
      const response = await fetch(cgiUrl, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
        },
        body: sendAddUserJson,
      })
      const text = await response.text()
      console.log(text)
      reloadTable()
      return
    }
    // アカウントを追加する処理をbuttonに登録
    const button = document.querySelector('#send-form-add-user-button')
    button.addEventListener('click', sendFormAddUser)
  </script>
</html>
